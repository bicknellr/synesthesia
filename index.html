<html>
<head>


<script type="application/javascript" src="./module.js"></script>
<script type="application/javascript" src="./Utilities.js"></script>
<script type="application/javascript" src="./Synesthesia.js"></script>
  <link rel="stylesheet" type="text/css" href="./Synesthesia.css" />
<script type="application/javascript" src="./Synesthesia.Graph.js"></script>
<script type="application/javascript" src="./Synesthesia.UI.js"></script>
  <link rel="stylesheet" type="text/css" href="./Synesthesia.UI.css" />
<script type="application/javascript" src="./Synesthesia.Library.js"></script>

<script type="application/javascript">

var KeyboardInput = (function () {
  function KeyboardInput (params) {
    this.params = (typeof params !== "undefined" ? params : {});
    this.synesthesia = this.params.synesthesia;
    this.notes = {};

    window.addEventListener("keydown", this.keydown.bind(this), false);
    window.addEventListener("keyup", this.keyup.bind(this), false);

    this.keyToFrequencyMapping = function (keyCode) {
      var frequencies = {
          /* bottom row */
          90: 261.626, // Z
          83: 277.183, // S
          88: 293.665, // X
          68: 311.127, // D
          67: 329.628, // C
          
          86: 349.228, // V
          71: 369.994, // G
          66: 391.995, // B
          72: 415.305, // H
          78: 440.000, // N
          74: 466.164, // J
          77: 493.883, // M
          
          188: 523.251, // comma
          76: 554.365, // L
          190: 587.330, // period
          186: 622.254, // semicolon
          191: 659.255, // slash
          
          /* top row */
          81: 523.251, // Q
          50: 554.365, // 2
          87: 587.330, // W
          51: 622.254, // 3
          69: 659.255, // E
          
          82: 698.456, // R
          53: 739.989, // 5
          84: 783.991, // T
          54: 830.609, // 6
          89: 880.000, // Y
          55: 932.328, // &
          85: 987.767, // U
          
          73: 1046.50, // I
          57: 1108.73, // 9
          79: 1174.66, // O
          48: 1244.51, // 0
          80: 1318.51 // P
      };

      return frequencies[keyCode];
    };
  }

  KeyboardInput.prototype.attach = function (syn) {
    this.synesthesia = syn;
  };

  KeyboardInput.prototype.keydown = function (e) {
    if (this.notes["" + e.keyCode]) return;

    var frequency = this.keyToFrequencyMapping(e.keyCode);
    if (!frequency) return;

    var note = new Synesthesia.Note({
      frequency: frequency,
      velocity: 1.0
    });

    this.notes["" + e.keyCode] = note;

    this.synesthesia.input({
      source: this,
      on: [note]
    });
  };

  KeyboardInput.prototype.keyup = function (e) {
    if (!this.notes["" + e.keyCode]) return;

    this.synesthesia.input({
      source: this,
      off: [this.notes["" + e.keyCode]]
    });

    delete this.notes["" + e.keyCode];
  };

  return KeyboardInput;
})();

window.addEventListener("load", function () {
  module("MAIN", ["Synesthesia", "Synesthesia.UI", "Synesthesia.Library"], function () {

    window.Synesthesia = require("Synesthesia");
    
    MainSynesthesia = new Synesthesia();
    MainUI = new Synesthesia.UI({
      node_canvas: document.getElementById("NodeCanvas"),
      node_div: document.getElementById("NodeDiv")
    });

    MainOutput = new Synesthesia.Library.MainOutput({
      synesthesia: MainSynesthesia
    });
    MainUI.addNode(MainOutput, {
      x: 300, y: 10
    });

    MainKeyboard = new KeyboardInput();
    MainKeyboard.attach(MainSynesthesia);

    TestOsc1 = new Synesthesia.Library.Oscillator({
      synesthesia: MainSynesthesia,
      type: Synesthesia.Library.Oscillator.Type.SINE
    });
    MainSynesthesia.mapInput(MainKeyboard, TestOsc1);
    MainUI.addNode(TestOsc1, {
      x: 20, y: 10
    });

    TestOsc2 = new Synesthesia.Library.Oscillator({
      synesthesia: MainSynesthesia,
      type: Synesthesia.Library.Oscillator.Type.SINE
    });
    MainSynesthesia.mapInput(MainKeyboard, TestOsc2);
    MainUI.addNode(TestOsc2, {
      x: 20, y: 170
    });

    TestGain1 = new Synesthesia.Library.Gain({
      synesthesia: MainSynesthesia
    });
    MainUI.addNode(TestGain1, {
      x: 300, y: 170
    });

    TestDelay1 = new Synesthesia.Library.Delay({
      synesthesia: MainSynesthesia
    });
    MainUI.addNode(TestDelay1, {
      x: 300, y: 330
    });

    // UI
    MainUI.start();

  });
}, false);

</script>
</head>
<body>

<!--
TODO: Set a single container div, have the main Synesthesia object
handle adding and managing the canvas and window container.
-->
<canvas id="NodeCanvas" width="640" height="480"></canvas>
<div id="NodeDiv"></div>

</body>
</html>
